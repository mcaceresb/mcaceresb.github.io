<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xml" href="http://localhost:4000/feed.xslt.xml"?><feed xmlns="http://www.w3.org/2005/Atom"><generator uri="http://jekyllrb.com" version="3.4.0">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2017-02-15T23:15:07-05:00</updated><id>http://localhost:4000//</id><title type="html">Mauricio Cáceres Bravo</title><subtitle>Hi! I am a research assistant at the National Bureau of Economic Research (NBER), based in Cambridge, MA. I double-majored in mathematics and economics at the University of Utah and I have a Master's degree in economics from Columbia University in New York.
This is my personal website, meant to force myself to speed along some coding projects I've had in the back-burner throughout the past year.
</subtitle><entry><title type="html">Writing my first Stata plugin: A real wold use case</title><link href="http://localhost:4000/stata/plugins/2017/02/14/writing-stata-plugins-example.html" rel="alternate" type="text/html" title="Writing my first Stata plugin: A real wold use case" /><published>2017-02-14T20:13:24-05:00</published><updated>2017-02-14T20:13:24-05:00</updated><id>http://localhost:4000/stata/plugins/2017/02/14/writing-stata-plugins-example</id><content type="html" xml:base="http://localhost:4000/stata/plugins/2017/02/14/writing-stata-plugins-example.html">&lt;script type=&quot;text/x-mathjax-config&quot;&gt;
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], [&quot;\\(&quot;,&quot;\\)&quot;] ],
      processEscapes: true
    }
  });
&lt;/script&gt;

&lt;script type=&quot;text/javascript&quot; src=&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;&gt;&lt;/script&gt;

&lt;p&gt;I’m not the biggest fan of Stata. Though I use it every day for RA work,
and Stata does shine when all you want to do is explore one data set (or
a series of data sets that are easy to merge), it’s become increasingly
apparent over time that whenever I want to do something complex or
computationally intensive, it pales.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;www.stata.com/features/overview/introduction-to-mata/&quot;&gt;Mata&lt;/a&gt; makes many
of the rougher corners of Stata rather bearable. However, optimizing
Stata for a speedy run is really difficult. Enter &lt;a href=&quot;www.stata.com/plugins/&quot;&gt;Stata plugins&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;what-are-stata-plugins&quot;&gt;What are Stata plugins?&lt;/h2&gt;

&lt;p&gt;A Stata plugin is pre-recompiled code, written in C or C++, that can
interact with Stata using the “Stata Plugin Interface (SPI).” Stata
provides a C source file and header that allows a C program to interact
with Stata’s data sets and matrices.&lt;/p&gt;

&lt;p&gt;The implementation is relatively crude. Stata can write/read to/from
C one observation at a time from/to existing variables and matrices.
&lt;a href=&quot;www.stata.com/plugins/&quot;&gt;Stata has pretty good documentation&lt;/a&gt; for the
functionality of their plugins, and I will not repeat all of it here.&lt;/p&gt;

&lt;p&gt;A simple hello world program would be as follows:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Get a C compiler (&lt;code&gt;gcc&lt;/code&gt;, the GNU Compiler Collection, is standard and should be included on Mac and Linux; look into &lt;a href=&quot;http://www.mingw.org&quot;&gt;MinGW&lt;/a&gt; if you are on Windows to use &lt;code&gt;gcc&lt;/code&gt;).&lt;/li&gt;
  &lt;li&gt;Download the Stata Splugin Interface (SPI) version 2 (Stata &amp;lt;= 13) or 3 (Stata &amp;gt;= 14).
    &lt;ul&gt;
      &lt;li&gt;Version 2: &lt;a href=&quot;http://www.stata.com/plugins/version2/stplugin.c&quot;&gt;stplugin.c&lt;/a&gt;, &lt;a href=&quot;http://www.stata.com/plugins/version2/stplugin.h&quot;&gt;stplugin.h&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;Version 3: &lt;a href=&quot;http://www.stata.com/plugins/stplugin.c&quot;&gt;stplugin.c&lt;/a&gt;, &lt;a href=&quot;http://www.stata.com/plugins/stplugin.h&quot;&gt;stplugin.h&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Create hello.c (Note you should have stplugin.h and stplugin.c in the same directory).&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;quot;stplugin.h&amp;quot;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;STDLL&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;stata_call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[])&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;SF_display&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hello World&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;Now from the command line, run&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;gcc -shared -fPIC -DSYSTEM&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;OPUNIX stplugin.c hello.c -o hello.plugin &lt;span class=&quot;c1&quot;&gt;# Linux&lt;/span&gt;
gcc -bundle -DSYSTEM&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;APPLEMAC stplugin.c hello.c -o hello.plugin     &lt;span class=&quot;c1&quot;&gt;# Mac&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;Last, from Stata navigate to your working directory and run&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-stata&quot; data-lang=&quot;stata&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;program&lt;/span&gt; hello,&lt;span class=&quot;k&quot;&gt; plugin&lt;/span&gt; using(&lt;span class=&quot;s&quot;&gt;&amp;quot;./hello.plugin&amp;quot;&lt;/span&gt;)&lt;span class=&quot;k&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;plugin&lt;/span&gt; call hello&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;is-it-worth-the-hassle&quot;&gt;Is it worth the hassle?&lt;/h2&gt;

&lt;p&gt;Stata says that it’s only worth it if you are replacing a lot of interpreted
ado-code and the task is not very complex. Though I agree on the latter
(complex tasks will likely take more time to code in C than the time they
will save) I &lt;em&gt;strongly&lt;/em&gt; disagree on the former.&lt;/p&gt;

&lt;p&gt;Perhaps most people realize this, but my understanding of for loops in
Stata is that they are run as if you printed each block within the for
loop however many times you tell it to execute. Thus&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-stata&quot; data-lang=&quot;stata&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;forvalues&lt;/span&gt; i = &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; / &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt; {
    &lt;span class=&quot;c1&quot;&gt;// Stuff to do&lt;/span&gt;
}&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;may look like three lines of code, but it’s really equivalent to 1000.
The reason I started using Stata plugins was to speed up a simulation.
The C code is longer and the base case are only a handful of lines in
Stata, but it’s painfully slow because the bulk of the computation takes
place inside a loop that does a simulation.&lt;/p&gt;

&lt;p&gt;Below I document a real-world use case where C was 50 times faster than
Stata, so for me the work was definitely worthwhile.&lt;/p&gt;

&lt;h2 id=&quot;a-real-world-use-case&quot;&gt;A real world use case&lt;/h2&gt;

&lt;p&gt;Several of the projects I work on are Randomized Control Trials. It is
standard to conduct a power analysis for such projects in order to put
together a proposal, etc. Having a well-powered trial is essential for
the success of an RCT.&lt;/p&gt;

&lt;p&gt;Since RCTs can give you a truly independent treatment variable, we can
recover the treatment effect via simple OLS. Though parametric methods
are well known and widely used to estimate power under this setup,
they rely on strong assumptions. When clustering or stratification are
involved, specially when the number of clusters is not very large,
parametric calculations can be inaccurate.&lt;/p&gt;

&lt;p&gt;One suggestion I got was to &lt;em&gt;simulate&lt;/em&gt; power. I won’t outline the full
rationale (&lt;a href=&quot;https://github.com/mcaceresb/stata-power/blob/master/notes/power-simulation-notes.pdf&quot;&gt;read about it here&lt;/a&gt;), but the crux of the idea is to simulate a large number of
coefficients $b$ for the equation:&lt;/p&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;Y_{ij} = a + b T_{ij} + g X_{ij} + e_{ij}&lt;/script&gt;

&lt;p&gt;where at each step of the simulation, $T_{ij}$ is simulated so that
there are $NP$ individuals/clusters in treatment and $(1 - P)N$
in control. Since treatment is assigned randomly, the resulting
distribution is a sample of the true distribution of $b$ under the null
$H_0: b = 0$.&lt;/p&gt;

&lt;p&gt;This does not tell us anything about power by itself, but the confidence
interval can be used as the basis of an iterative procedure to simulate
power. Hence coding the simulation efficiently is crucial.&lt;/p&gt;

&lt;h2 id=&quot;why-write-a-plugin&quot;&gt;Why write a plugin?&lt;/h2&gt;

&lt;p&gt;The problem above is actually very simple to implement. In pseudo-code:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-stata&quot; data-lang=&quot;stata&quot;&gt;&lt;span&gt;&lt;/span&gt;function simci (X, y, P, reps)
{
&lt;span class=&quot;k&quot;&gt;    n&lt;/span&gt; = rows(X)
    b = zeros(reps)
    T = ones(&lt;span class=&quot;nf&quot;&gt;ceil(&lt;/span&gt;n * P)) \ zeros(&lt;span class=&quot;nf&quot;&gt;floor(&lt;/span&gt;n * (&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; - P)))

&lt;span class=&quot;k&quot;&gt;    for&lt;/span&gt; (r = &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;; r &amp;lt;= reps; r++)
    {
        XT   = shuffle(T), X
        b[r] = (&lt;span class=&quot;nf&quot;&gt;inv(&lt;/span&gt;XT&amp;#39; * XT) * (XT&amp;#39; * y))[&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;]
    }

&lt;span class=&quot;k&quot;&gt;    return&lt;/span&gt; (b)
}&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Though simple, doing this &lt;em&gt;&lt;strong&gt;efficiently&lt;/strong&gt;&lt;/em&gt; is impossible in
Stata. There are three prominent issues:&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;There is no way to shuffle a vector in Stata. That’s not a thing.
Variables all exist in relation to each other and sorting one
variable randomly will sort the entire data set. Shuffling an entire
data set is much slower than shuffling one vector.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;There is no way to compute just the regression coefficients in Stata.
Stata’s &lt;code&gt;regress&lt;/code&gt; computes a host of things along with the least
squares solution This adds unnecessary overhead. (I have asked about
how to do this before; the suggestion I got was to run &lt;code&gt;quietly
regress, notable&lt;/code&gt; which just controls what Stata outputs, not what it
computes).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;It’s not obvious how to store the results, specially with Stata/IC.
Though the buffer versions of Stata should be able to handle most
simulations after setting a larger &lt;code&gt;matsize&lt;/code&gt;, the fact matrix sizes
are capped (and in Stata/IC capped at 800), makes the function
difficult to code.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The solution in Stata would look like this&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-stata&quot; data-lang=&quot;stata&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;program&lt;/span&gt; stataSimci, rclass sortpreserve
&lt;span class=&quot;k&quot;&gt;    syntax varlist&lt;/span&gt; [if] [in] , [ Ptreat(real &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;) reps(int &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;) ]

&lt;span class=&quot;k&quot;&gt;    gettoken&lt;/span&gt; depvar controls:&lt;span class=&quot;k&quot;&gt; varlist&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;    marksample&lt;/span&gt; touse
    _rmcoll &lt;span class=&quot;nv&quot;&gt;`controls&amp;#39;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt; if&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`touse&amp;#39;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;    local&lt;/span&gt; controls `&lt;span class=&quot;nf&quot;&gt;r(&lt;/span&gt;varlist)&amp;#39;

&lt;span class=&quot;k&quot;&gt;    qui&lt;/span&gt; {
&lt;span class=&quot;k&quot;&gt;    preserve&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;        keep if&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`touse&amp;#39;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;        local&lt;/span&gt; NP = &lt;span class=&quot;nf&quot;&gt;ceil(&lt;/span&gt;`=_N&amp;#39; * &lt;span class=&quot;nv&quot;&gt;`ptreat&amp;#39;&lt;/span&gt;)

&lt;span class=&quot;k&quot;&gt;        tempname&lt;/span&gt; b
&lt;span class=&quot;k&quot;&gt;        tempvar&lt;/span&gt; treatment randsort
&lt;span class=&quot;k&quot;&gt;        gen&lt;/span&gt; byte   &lt;span class=&quot;nv&quot;&gt;`treatment&amp;#39;&lt;/span&gt; = .
&lt;span class=&quot;k&quot;&gt;        gen&lt;/span&gt; double &lt;span class=&quot;nv&quot;&gt;`randsort&amp;#39;&lt;/span&gt;  = .

&lt;span class=&quot;k&quot;&gt;        forvalues&lt;/span&gt; r = &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; / &lt;span class=&quot;nv&quot;&gt;`reps&amp;#39;&lt;/span&gt; {
&lt;span class=&quot;k&quot;&gt;            replace&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`randsort&amp;#39;&lt;/span&gt;  = &lt;span class=&quot;nf&quot;&gt;runiform(&lt;/span&gt;)
&lt;span class=&quot;k&quot;&gt;            sort&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`randsort&amp;#39;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;            replace&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`treatment&amp;#39;&lt;/span&gt; = (_n &amp;lt;= &lt;span class=&quot;nv&quot;&gt;`NP&amp;#39;&lt;/span&gt;)
&lt;span class=&quot;k&quot;&gt;            regress&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`depvar&amp;#39;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`treatment&amp;#39;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`controls&amp;#39;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt; if&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`touse&amp;#39;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;            matrix&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`b&amp;#39;&lt;/span&gt; = &lt;span class=&quot;nf&quot;&gt;nullmat(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;`b&amp;#39;&lt;/span&gt;) \ `:di _b[&lt;span class=&quot;nv&quot;&gt;`treatment&amp;#39;&lt;/span&gt;]&amp;#39;
        }
&lt;span class=&quot;k&quot;&gt;    restore&lt;/span&gt;
    }

&lt;span class=&quot;k&quot;&gt;    return matrix&lt;/span&gt; b = &lt;span class=&quot;nv&quot;&gt;`b&amp;#39;&lt;/span&gt;
end

&lt;span class=&quot;k&quot;&gt;sysuse&lt;/span&gt; auto,&lt;span class=&quot;k&quot;&gt; clear&lt;/span&gt;
stataSimci price mpg foreign, p(&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;) reps(&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;)&lt;span class=&quot;k&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;matrix list&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;r(&lt;/span&gt;b)&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This is a hugely inefficient program!&lt;/p&gt;

&lt;h2 id=&quot;wait-cant-mata-handle-these-things&quot;&gt;Wait, can’t Mata handle these things?&lt;/h2&gt;

&lt;p&gt;Right, Mata is the elephant in the room. If you don’t know,
&lt;a href=&quot;http://www.stata.com/features/overview/introduction-to-mata/&quot;&gt;Mata&lt;/a&gt; is
a programming language that is shipped with every version of Stata and
it can interact with Stata relatively easily. If you have ever used an
object-oriented programming language then you will recognize Mata as a
more standard programming language than Stata.&lt;/p&gt;

&lt;p&gt;Mata does afford us &lt;em&gt;some&lt;/em&gt; efficiency, but not a lot (yes, I know about
&lt;code&gt;.mlib&lt;/code&gt; files and that technically Stata compiles mata into bytecode
when read into memory, but I have never found the speed improvement to
be significant).&lt;/p&gt;

&lt;p&gt;In this case, Mata will run faster largely because it can&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Shuffle just a single vector.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Get the OLS coefficients without any additional computations.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The implementation is very straightforward:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-stata&quot; data-lang=&quot;stata&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;program&lt;/span&gt; mataSimci, rclass sortpreserve
&lt;span class=&quot;k&quot;&gt;    syntax varlist&lt;/span&gt; [if] [in] , [ Ptreat(real &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;) reps(int &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;) ]
&lt;span class=&quot;k&quot;&gt;    gettoken&lt;/span&gt; depvar controls:&lt;span class=&quot;k&quot;&gt; varlist&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;    marksample&lt;/span&gt; touse
    _rmcoll &lt;span class=&quot;nv&quot;&gt;`controls&amp;#39;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt; if&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`touse&amp;#39;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;    local&lt;/span&gt; controls `&lt;span class=&quot;nf&quot;&gt;r(&lt;/span&gt;varlist)&amp;#39;
&lt;span class=&quot;k&quot;&gt;    mata&lt;/span&gt;: b = simci(&lt;span class=&quot;s&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;`depvar&amp;#39;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&lt;/span&gt;, &lt;span class=&quot;s&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;`controls&amp;#39;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&lt;/span&gt;, &lt;span class=&quot;s&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;`touse&amp;#39;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&lt;/span&gt;, &lt;span class=&quot;nv&quot;&gt;`ptreat&amp;#39;&lt;/span&gt;, &lt;span class=&quot;nv&quot;&gt;`reps&amp;#39;&lt;/span&gt;)
&lt;span class=&quot;k&quot;&gt;    mata&lt;/span&gt;: st_matrix(&lt;span class=&quot;s&quot;&gt;&amp;quot;b&amp;quot;&lt;/span&gt;, b)
&lt;span class=&quot;k&quot;&gt;    return matrix&lt;/span&gt; b = b
end

&lt;span class=&quot;k&quot;&gt;mata&lt;/span&gt;:
real colvector function simci(string&lt;span class=&quot;k&quot;&gt; scalar&lt;/span&gt; depvar,
                              string&lt;span class=&quot;k&quot;&gt; scalar&lt;/span&gt; controls,
                              string&lt;span class=&quot;k&quot;&gt; scalar&lt;/span&gt; touse,
                              real&lt;span class=&quot;k&quot;&gt; scalar&lt;/span&gt; P,
                              real&lt;span class=&quot;k&quot;&gt; scalar&lt;/span&gt; reps)
{
    real&lt;span class=&quot;k&quot;&gt; scalar n&lt;/span&gt;
    real colvector b, T, y
    real&lt;span class=&quot;k&quot;&gt; matrix&lt;/span&gt; X

    y = X = .
    st_view(y, ., depvar,   touse)
    st_view(X, ., controls, touse)

&lt;span class=&quot;k&quot;&gt;    n&lt;/span&gt; = rows(X)
    b = &lt;span class=&quot;nf&quot;&gt;J(&lt;/span&gt;reps, &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;, missingof(X))
    T = &lt;span class=&quot;nf&quot;&gt;J(ceil(&lt;/span&gt;n * P), &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;) \ &lt;span class=&quot;nf&quot;&gt;J(floor(&lt;/span&gt;n * (&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; - P)), &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;)

&lt;span class=&quot;k&quot;&gt;    for&lt;/span&gt; (r = &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;; r &amp;lt;= reps; r++)
    {
        XT   = (jumble(T), X)
        b[r] = (&lt;span class=&quot;nf&quot;&gt;invsym(&lt;/span&gt;cross(XT, &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;, XT, &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;)) *&lt;span class=&quot;k&quot;&gt; cross&lt;/span&gt;(XT, &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;, y, &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;))[&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;]
    }

&lt;span class=&quot;k&quot;&gt;    return&lt;/span&gt;(b)
}
end

&lt;span class=&quot;k&quot;&gt;sysuse&lt;/span&gt; auto,&lt;span class=&quot;k&quot;&gt; clear&lt;/span&gt;
mataSimci price mpg foreign, p(&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;) reps(&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;)&lt;span class=&quot;k&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;matrix list&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;r(&lt;/span&gt;b)&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;There are two problems:&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Matrix operations in Mata are not terribly fast (certainly not
compered to a compiled language like C or even a JIT-compiled
language like Julia). Yes, I know Mata uses LAPACK and BLAS
underneath, but it’s still largely an interpreted language.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;There is no reason to run the loop sequentially! It is conceptually
trivial to parallelize the loop. Granted, parallelism is not trivial
but the fact it cannot be done, even in Stata/MP, is frustrating.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;how-does-the-solution-in-c-look-like&quot;&gt;How does the solution in C look like?&lt;/h2&gt;

&lt;p&gt;C is certainly harder to write, and Stata’s primitive interaction with
C makes it so getting the results back from C is annoying. BUT there is
a MASSIVE speed improvement. For this particular use case it’s an order
of magnitude (around 10x) over Mata (and that implementation was already
faster than Stata).&lt;/p&gt;

&lt;p&gt;Writing the wrapper for this is not too hard thanks to the GNU
Scientific Library. Noting the 0-based indexing:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;math.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;omp.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;time.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;gsl/gsl_blas.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;gsl/gsl_linalg.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;gsl/gsl_matrix_double.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;gsl/gsl_permutation.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;gsl/gsl_randist.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;gsl/gsl_rng.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;quot;stplugin.h&amp;quot;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// These functions are to be used after reading Stata data into X, y.&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// Crucially, in this example the first column of X must be empty.&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;simci&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_matrix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reps&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
           &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;sim_ols&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_matrix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// This function would read the data from stata&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;STDLL&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;stata_call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[])&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Initialize the variables to use&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ST_int&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ST_double&lt;/span&gt;   &lt;span class=&quot;n&quot;&gt;z&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ST_retcode&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;rc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Get P and number of reps. Note the 0-based indexing! So the&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// functiona ssumes P and reps were the 2nd and 3rd argument.&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;P&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strtod&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strtod&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SF_in2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SF_nvars&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_matrix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_matrix_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Not sure if there is another way to read data vs the double loop.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Again, careful with the 0-based indexing!&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SF_in1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SF_in2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SF_ifobs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

            &lt;span class=&quot;c1&quot;&gt;// Variables 2 through k are covariates&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;c1&quot;&gt;// Note we leave the first column empty&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SF_vdata&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;z&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;gsl_matrix_set&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;z&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

            &lt;span class=&quot;c1&quot;&gt;// Note we add the constant&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;gsl_matrix_set&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

            &lt;span class=&quot;c1&quot;&gt;// Variable 1 is the dependent variable&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SF_vdata&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;z&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;gsl_vector_set&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;z&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Now we call the simulation function and output the results into b&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reps&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;simci&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reps&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;gsl_matrix_free&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector_free&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Note the first argument passed to the plugin call must be the&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// name of a matrix that exists in Stata.&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;SF_mat_store&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector_get&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// The method above is a hassle because Stata limits matrix size and&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// the matrix has to exist. Some workarounds:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// - Space-delimited local macro, then read using mata: tokens()&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// - Write to a temporary file then read using mata: cat()&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// This will output the results into b&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;simci&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_matrix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reps&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
           &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ceil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Set the random seed based on the time of day (seconds)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;srand&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_rng&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rng&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_rng_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gsl_rng_default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_rng_set&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rng&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Get vector of 1s and 0s&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector_set_zero&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;gsl_vector_set&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Initialize elements for parallel loop&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Tp&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_matrix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Xp&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Parallelize execution&lt;/span&gt;
    &lt;span class=&quot;cp&quot;&gt;#pragma omp parallel private(Xp, Tp) shared(y, b)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// Allocate to each therad their own copy&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Tp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Xp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_matrix_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;gsl_vector_memcpy&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Tp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;gsl_matrix_memcpy&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Xp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// Parallel for loop through simulation&lt;/span&gt;
        &lt;span class=&quot;cp&quot;&gt;#pragma omp for&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reps&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;gsl_ran_shuffle&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rng&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Tp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;gsl_matrix_set_col&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Xp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Tp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;gsl_vector_set&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sim_ols&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Xp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// Cleanup&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;gsl_matrix_free&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Xp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;gsl_vector_free&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Tp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Cleanup&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector_free&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_rng_free&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rng&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;sim_ols&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_matrix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Allocate memory to express the system as Ax = b&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_matrix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;A&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_matrix_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl_vector_alloc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Set A = X&amp;#39; X and b = X&amp;#39; y&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_blas_dgemm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CblasTrans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CblasNoTrans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_blas_dgemv&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CblasTrans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Cholesky decomposition&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_linalg_cholesky_decomp1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_linalg_cholesky_solve&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Cleanup&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_matrix_free&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsl_vector_free&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gsl_vector_get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Save the code to &lt;code&gt;pluginSimci.c&lt;/code&gt;. To compile &lt;code&gt;pluginSimci.plgin&lt;/code&gt;, on top
of &lt;code&gt;gcc&lt;/code&gt; and the SPI, you will need&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;The &lt;a href=&quot;https://www.gnu.org/software/gsl&quot;&gt;GNU Scientific Library (GSL)&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.openmp.org&quot;&gt;OpenMP&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Again, you should have &lt;code&gt;stplugin.c&lt;/code&gt; and &lt;code&gt;stplugin.h&lt;/code&gt; in the same directory. Now on Linux/Unix, run&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CFLAGS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;-Wall -fopenmp -shared -fPIC -DSYSTEM=OPUNIX&amp;quot;&lt;/span&gt;
gcc &lt;span class=&quot;nv&quot;&gt;$CFLAGS&lt;/span&gt; -c -o stplugin.o    stplugin.c
gcc &lt;span class=&quot;nv&quot;&gt;$CFLAGS&lt;/span&gt; -c -o pluginSimci.o pluginSimci.c
gcc &lt;span class=&quot;nv&quot;&gt;$CFLAGS&lt;/span&gt; stplugin.o pluginSimci.o &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    -lgsl -lgslcblas -lm -o pluginSimci.plugin&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Depending on your system, you may also need to add &lt;code&gt;-std=c99&lt;/code&gt; as a flag and point to the location of the &lt;code&gt;libgsl*so&lt;/code&gt; files. For instance, I regularly SSH into a RedHat server, and to compile I ran&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CFLAGS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;-Wall -std=c99 -fopenmp -shared -fPIC -DSYSTEM=OPUNIX&amp;quot;&lt;/span&gt;
gcc -I/usr/local/lib &lt;span class=&quot;nv&quot;&gt;$CFLAGS&lt;/span&gt; -c -o stplugin.o    stplugin.c
gcc -I/usr/local/lib &lt;span class=&quot;nv&quot;&gt;$CFLAGS&lt;/span&gt; -c -o pluginSimci.o pluginSimci.c
gcc -L/usr/local/lib &lt;span class=&quot;nv&quot;&gt;$CFLAGS&lt;/span&gt;  stplugin.o pluginSimci.o &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    -lgsl -lgslcblas -lm -o pluginSimci.plugin&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;To compile in other system, you should consult &lt;a href=&quot;http://www.stata.com/plugins&quot;&gt;Stata’s documentation&lt;/a&gt;. Once compiled, from Stata:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-stata&quot; data-lang=&quot;stata&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;matrix&lt;/span&gt; b = &lt;span class=&quot;nf&quot;&gt;J(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;, .)&lt;span class=&quot;k&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;sysuse&lt;/span&gt; auto&lt;span class=&quot;k&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;program&lt;/span&gt; pluginSimci,&lt;span class=&quot;k&quot;&gt; plugin&lt;/span&gt; using(./pluginSimci&lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;plugin)&lt;span class=&quot;k&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;plugin&lt;/span&gt; call pluginSimci price mpg foreign, b &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;matrix list&lt;/span&gt; b&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;timing-performance&quot;&gt;Timing performance&lt;/h2&gt;

&lt;p&gt;I don’t really know of good Stata tools to profile performance. However,
it’s not too hard to time how long a command takes to run. I wrote a
simple wrapper for it, which we use with the programs above:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-stata&quot; data-lang=&quot;stata&quot;&gt;&lt;span&gt;&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt; local&lt;/span&gt; github https:&lt;span class=&quot;c1&quot;&gt;//raw.githubusercontent.com&lt;/span&gt;
.&lt;span class=&quot;k&quot;&gt; net&lt;/span&gt; install benchmark, from(&lt;span class=&quot;nv&quot;&gt;`github&amp;#39;&lt;/span&gt;/mcaceresb/stata-benchmark/master/)
.&lt;span class=&quot;k&quot;&gt; local&lt;/span&gt; benchmark benchmark,&lt;span class=&quot;k&quot;&gt; disp&lt;/span&gt; reps(&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;):&lt;span class=&quot;k&quot;&gt; qui&lt;/span&gt;

.&lt;span class=&quot;k&quot;&gt; set&lt;/span&gt; seed &lt;span class=&quot;m&quot;&gt;42&lt;/span&gt;
.&lt;span class=&quot;k&quot;&gt; set&lt;/span&gt; matsize &lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;
.&lt;span class=&quot;k&quot;&gt; sysuse&lt;/span&gt; auto,&lt;span class=&quot;k&quot;&gt; clear&lt;/span&gt;
.&lt;span class=&quot;k&quot;&gt; tempfile&lt;/span&gt; auto
.&lt;span class=&quot;k&quot;&gt; save&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`auto&amp;#39;&lt;/span&gt;
.&lt;span class=&quot;k&quot;&gt; qui forvalues&lt;/span&gt; i = &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; / &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt; {
.    &lt;span class=&quot;k&quot;&gt; append&lt;/span&gt; using &lt;span class=&quot;nv&quot;&gt;`auto&amp;#39;&lt;/span&gt;
. }

. &lt;span class=&quot;nv&quot;&gt;`benchmark&amp;#39;&lt;/span&gt; stataSimci  price mpg foreign, p(&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;) reps(&lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;)
&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;: &lt;span class=&quot;m&quot;&gt;10.52&lt;/span&gt; seconds
&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;: &lt;span class=&quot;m&quot;&gt;9.143&lt;/span&gt; seconds
&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;: &lt;span class=&quot;m&quot;&gt;12.13&lt;/span&gt; seconds
&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;: &lt;span class=&quot;m&quot;&gt;14.25&lt;/span&gt; seconds
&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;: &lt;span class=&quot;m&quot;&gt;12.54&lt;/span&gt; seconds
Average over &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt; runs: &lt;span class=&quot;m&quot;&gt;11.7166&lt;/span&gt; seconds

. &lt;span class=&quot;nv&quot;&gt;`benchmark&amp;#39;&lt;/span&gt; mataSimci  price mpg foreign, p(&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;) reps(&lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;)
 &lt;span class=&quot;m&quot;&gt;2.546&lt;/span&gt; seconds
 &lt;span class=&quot;m&quot;&gt;2.692&lt;/span&gt; seconds
 &lt;span class=&quot;m&quot;&gt;2.68&lt;/span&gt; seconds
 &lt;span class=&quot;m&quot;&gt;2.368&lt;/span&gt; seconds
 &lt;span class=&quot;m&quot;&gt;2.426&lt;/span&gt; seconds
Average over &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt; runs: &lt;span class=&quot;m&quot;&gt;2.5424&lt;/span&gt; seconds

.&lt;span class=&quot;k&quot;&gt; matrix&lt;/span&gt; b = &lt;span class=&quot;nf&quot;&gt;J(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;, &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;, .)
. &lt;span class=&quot;nv&quot;&gt;`benchmark&amp;#39;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt; plugin&lt;/span&gt; call pluginSimci price mpg foreign, b &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;
&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;: .&lt;span class=&quot;m&quot;&gt;283&lt;/span&gt; seconds
&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;: .&lt;span class=&quot;m&quot;&gt;273&lt;/span&gt; seconds
&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;: .&lt;span class=&quot;m&quot;&gt;262&lt;/span&gt; seconds
&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;: .&lt;span class=&quot;m&quot;&gt;238&lt;/span&gt; seconds
&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;: .&lt;span class=&quot;m&quot;&gt;288&lt;/span&gt; seconds
Average over &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt; runs: &lt;span class=&quot;m&quot;&gt;0.2688&lt;/span&gt; seconds&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;In the example Mata ran 5x vs Stata and the plugin ran 10x vs Mata. For
a 50x speed improvement, I’d say the hassle was worth it! My real-world
use-case for this was power simulations for a cluster-randomized trial
where the underlying clusters were comprised of 200k observations
overall. Running this in Mata took on the order of days. To have it run
in hours was a massive boon.&lt;/p&gt;</content><summary type="html"></summary></entry><entry><title type="html">Installing Arch: Setting up the system</title><link href="http://localhost:4000/linux/arch/install/2017/02/10/install-arch-partI.html" rel="alternate" type="text/html" title="Installing Arch: Setting up the system" /><published>2017-02-10T08:28:24-05:00</published><updated>2017-02-10T08:28:24-05:00</updated><id>http://localhost:4000/linux/arch/install/2017/02/10/install-arch-partI</id><content type="html" xml:base="http://localhost:4000/linux/arch/install/2017/02/10/install-arch-partI.html">&lt;p&gt;I am a fan of &lt;a href=&quot;https://en.wikipedia.org/wiki/GNU/Linux&quot;&gt;GNU/Linux&lt;/a&gt; (or
just “Linux” if you hate Richard Stallman). My first Linux distro was
&lt;a href=&quot;https://www.ubuntu.com/&quot;&gt;Ubuntu&lt;/a&gt; but, alas, it was not meant to be.
Though Ubuntu is truly awesome for putting ease of use front and center,
over time my idea of “ease of use” started to drift from Ubuntu’s idea
of ease of use.&lt;/p&gt;

&lt;p&gt;These days I have gravitated towards Arch. The
&lt;a href=&quot;https://wiki.archlinux.org&quot;&gt;Arch wiki&lt;/a&gt; is awesome
and a half, and they have a full &lt;a href=&quot;https://wiki.archlinux.org/index.php/Beginners%27_guide&quot;&gt;installation
guide&lt;/a&gt;
available. However, there is a specific setup I like most and this is
meant to summarize that setup into an easy-to-follow step-by-step guide.&lt;/p&gt;

&lt;p&gt;Commands between &lt;code&gt;[encryption-lvm]&lt;/code&gt; tags need only be run if you want
to set up encryption with LVM and they are run in lieu of commands
in &lt;code&gt;[standatd]&lt;/code&gt; tags (LVM is recommended; easiest guide I found is
&lt;a href=&quot;http://www.brandonkester.com/tech/2013/03/16/full-disk-encryption
-in-arch-linux-with-uefi.html&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;

&lt;h2 id=&quot;step-1-partition-and-format-the-drive&quot;&gt;Step 1: Partition and format the drive&lt;/h2&gt;

&lt;p&gt;Some basic sanity checks&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;ls /sys/firmware/efi/efivars # Should be populated
wifi-menu                    # Will connect automatically
timedatectl set-ntp true
timedatectl status
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now partition the disk (EFI)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;# I use parted; alternatively use gdisk or cdisk
parted /dev/sda
mklabel gpt
mkpart ESP fat32 1MiB 513MiB
set 1 boot on

# [encryption-lvm]
mkpart primary ext4 513MiB 100%
# [encryption-lvm]

# [standard]
mkpart primary linux-swap 513MiB 8.5GiB
mkpart primary ext4 8.5GiB 100%
# [standard]

quit
mkfs.vfat /dev/sda1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Format drive and mount&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;# [encryption-lvm]
cryptsetup luksFormat /dev/sda2
cryptsetup open --type luks /dev/sda2 lvm
pvcreate /dev/mapper/lvm
vgcreate vol0 /dev/mapper/lvm
lvcreate --name lvswap -L 6GB vol0
lvcreate --name lvroot -l 100%FREE vol0
mkswap /dev/mapper/vol0-lvswap
swapon /dev/mapper/vol0-lvswap
mkfs.ext4 /dev/mapper/vol0-lvroot
mount /dev/mapper/vol0-lvroot /mnt
# [encryption-lvm]

# [standard]
mkfs.ext4 /dev/sda3
mkswap /dev/sda2
swapon /dev/sda2
mount /dev/sda3 /mnt
# [standard]

mkdir /mnt/boot
mount /dev/sda1 /mnt/boot
pacstrap -i /mnt base base-devel
# If you get a PGP key error, do
# dirmngr &amp;lt;/dev/null
# pacman-key --populate archlinux
# pacman-key --refresh-keys
# Then retun pacstrap
genfstab -U /mnt &amp;gt; /mnt/etc/fstab
cp /etc/netctl/yournetworkname /mnt/etc/netctl/yournetworkname
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; If you want to mount extra partitions, make sure you mounted them here. For instance, &lt;code&gt;mkdir  /mnt/mnt/large &amp;amp;&amp;amp; mount /dev/sdY1 /mnt/mnt/large&lt;/code&gt; or something, &lt;em&gt;BEFORE&lt;/em&gt; &lt;code&gt;genfstab&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;step-2-chroot-and-install-base-system&quot;&gt;Step 2: Chroot and install base system&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;arch-chroot /mnt /bin/bash

locale-gen
localectl set-locale LANG=en_US.UTF-8
vi /etc/locale.gen # Uncomment en_US.UTF-8
echo LANG=en_US.UTF-8 &amp;gt; /etc/locale.conf
export `cat /etc/locale.conf`
locale-gen

tzselect
ln -s /usr/share/zoneinfo/America/New_York /etc/localtime
hwclock --systohc --utc

echo vm.swappiness=10 &amp;gt; /etc/sysctl.d/99-sysctl.conf
vi /etc/pacman.conf # Uncomment multilib

echo hostname &amp;gt; /etc/hostname
vi /etc/hosts
# Copy the 127.0.0.1 and replace localhost with hostname

pacman -Sy
pacman -S iw wpa_supplicant dialog intel-ucode
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;step-3-configure-the-boot-loader&quot;&gt;Step 3: Configure the boot loader&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;&lt;strong&gt;Pro-tip:&lt;/strong&gt;&lt;/em&gt; I have occasionally messed up my bootloader; when that happens I fire up a live arch USB, mount my partitions (using lvm if applicable), chroot into the system, and fix the bootloader here.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;bootctl install
cp /usr/share/systemd/bootctl/arch.conf /boot/loader/entries/
echo `blkid /dev/sdb2` &amp;gt;&amp;gt; /boot/loader/entries/arch.conf
# File should look like this
#   title   Arch Lnux
#   linux   /vmlinuz-linux
#   initrd  /initramfs-linux.img
# [encryption-lvm]
#   options cryptdevice=UUID=&amp;lt;INSERT-UUID-HERE&amp;gt;:lvm:allow-discards resume=/dev/mapper/vol0-lvswap root=/dev/mapper/vol0-lvroot rw quiet
# [encryption-lvm]
# [standard]
#   options root=PARTUUID=&amp;lt;INSERT-PARTUUID-HERE&amp;gt; rootfstype=ext4 rw
# [standard]

bootctl update
# [encryption-lvm]
# vi /etc/mkinitcpio.conf
#   Add &quot;keymap encrypt lvm2 resume&quot; to HOOKS=&quot;...&quot;
#   HOOKS=&quot;base udev autodetect modconf block keymap encrypt lvm2 resume filesystems keyboard fsck&quot;
# [encryption-lvm]

mkinitcpio -p linux
passwd
exit
umount -R /mnt/boot
umount -R /mnt
reboot
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;step-4-set-up-your-own-user-account&quot;&gt;Step 4: Set up your own user account&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;useradd -m -s /bin/bash user
passwd user
visudo # Add to end of file: user ALL=(ALL) ALL
pacman -S sudo bash-completion git rfkill
exit
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Log in and install install pacaur. You can use &lt;code&gt;pacaur&lt;/code&gt; (though I think using &lt;code&gt;yaourt&lt;/code&gt; is more standard) to query the &lt;a href=&quot;aur.archlinux.org&quot;&gt;Arch User Repositories (AUR)&lt;/a&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;mkdir ~/Documents
mkdir ~/Downloads
mkdir ~/Pictures
mkdir ~/Music
mkdir ~/Videos

cd ~/Downloads
git clone https://aur.archlinux.org/package-query
git clone https://aur.archlinux.org/yaourt
cd package-query
makepkg -si
cd ../yaourt
makepkg -si

# yaourt is supposedly standard but can be very annoying.
# I've been trying out pacaur
gpg --recv-keys 1EB2638FF56C0C53
yaourt -S pacaur
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can now follow my preferred setup or go to &lt;a href=&quot;http://https://wiki.archlinux.org/index.php/General_recommendations&quot;&gt;the recommendations page&lt;/a&gt;&lt;/p&gt;</content><summary type="html">I am a fan of GNU/Linux (or
just “Linux” if you hate Richard Stallman). My first Linux distro was
Ubuntu but, alas, it was not meant to be.
Though Ubuntu is truly awesome for putting ease of use front and center,
over time my idea of “ease of use” started to drift from Ubuntu’s idea
of ease of use.</summary></entry></feed>
