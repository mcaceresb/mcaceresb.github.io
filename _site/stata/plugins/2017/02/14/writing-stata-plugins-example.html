<!DOCTYPE html>
<html>
  <head>
    
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" href="/static/img/favicon.ico" />
        <title>Writing my first Stata plugin: A real world use case - Mauricio M. Caceres Bravo</title>
        <meta name="author" content="Mauricio M. Caceres Bravo" />
        <meta name="description" content="Writing my first Stata plugin: A real world use case" />
        <meta name="keywords" content="Writing my first Stata plugin: A real world use case, Mauricio M. Caceres Bravo, stata, plugins" />

        <meta content="0" property="fb:app_id">
        <meta content="Mauricio M. Caceres Bravo" property="og:site_name">
        
          <meta content="Writing my first Stata plugin: A real world use case" property="og:title">
        
        
          <meta content="article" property="og:type">
        
        
          <meta content="Hi! I am an Assistant Professor at the Department of Economics and Finance in Baruch College's Zicklin School of Business, part of the City University of New York (CUNY). Welcome to my personal website, where you'll find information on my research projects, coding, and teaching.
I received my PhD in Economics from Brown University in Providence, RI. I have Bachelor's degrees in mathematics and economics from the University of Utah and I have a Master's degree in economics from Columbia University in New York.
" property="og:description">
        
        
          <meta content="http://localhost:4000/stata/plugins/2017/02/14/writing-stata-plugins-example.html" property="og:url">
        
        
          <meta content="2017-02-14T20:13:24-05:00" property="article:published_time">
          <meta content="http://localhost:4000/about/" property="article:author">
        
        
          <meta content="http://localhost:4000/static/img/logo-high-resolution.png" property="og:image">
        
        
          
          <meta content="stata" property="article:section">
          
        
        
          
        
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@\#">
        <meta name="twitter:creator" content="@\#">
        
          <meta name="twitter:title" content="Writing my first Stata plugin: A real world use case">
        
        
          <meta name="twitter:url" content="http://localhost:4000/stata/plugins/2017/02/14/writing-stata-plugins-example.html">
        
        
          <meta name="twitter:description" content="Hi! I am an Assistant Professor at the Department of Economics and Finance in Baruch College's Zicklin School of Business, part of the City University of New York (CUNY). Welcome to my personal website, where you'll find information on my research projects, coding, and teaching.
I received my PhD in Economics from Brown University in Providence, RI. I have Bachelor's degrees in mathematics and economics from the University of Utah and I have a Master's degree in economics from Columbia University in New York.
">
        
        

      <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
      <script type="text/javascript">window.baseurl = 'http://localhost:4000';</script>
    
        <!-- Custom Fonts -->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">

        <!-- FontAwesome icons -->
        <link rel="stylesheet" href="https://use.fontawesome.com/74dfc6cf47.css">

        <link rel="stylesheet" href="/static/css/styles.css">
        <!-- Core BootStrap CSS -->
        <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"> -->
        <link rel="stylesheet" href="/static/css/bootstrap.min.css">
        <!-- Material Design CSS -->
        <link rel="stylesheet" href="/static/css/bootstrap-material-design.min.css">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/static/css/syntax.css">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/stata.min.js">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/python.min.js">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/highlight.min.js"></script>

        <!-- <link rel="stylesheet" href="/static/highlight.js/styles/isbl&#45;editor&#45;dark.css"> -->
        <link rel="stylesheet" href="/static/highlight.js/styles/github.css">
        <script src="/static/highlight.js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        <!-- Custom CSS -->        
        <link rel="stylesheet" href="/static/css/thickbox.css">
        <link rel="stylesheet" href="/static/css/main.css">
        <link rel="stylesheet" href="/static/css/projects.css">
        <link rel="stylesheet" href="/static/css/resume.css">

        <script type="text/javascript">
          //loadingImage is relative to project dir
          var tb_pathToImage = "/static/img/loadingAnimation.gif";
        </script>

  </head>

  <body class="home overflow-hidden">
    <div class="header-panel shadow-z-2">
    <div class="container">
        <div class="row">
          <div class="col-md-6 col-sm-8 col-xs-24">
            <div class="row-picture"></div>
            <div class="row-details">
              <h1 class="list-group-item-heading">Mauricio M. Caceres Bravo</h1>
              <p class="list-group-item-text" style="font-size:18px;">Assistant Professor at Baruch College, CUNY</p>
              <!-- <div class="social-icons">
	
        <a class="icon" target="_blank" href=""><i class="fa fa-facebook"></i></a>
    
        <a class="icon" target="_blank" href=""><i class="fa fa-twitter"></i></a>
    
        <a class="icon" target="_blank" href=""><i class="fa fa-linkedin"></i></a>
    
        <a class="icon" target="_blank" href=""><i class="fa fa-stack-exchange"></i></a>
    
</div>
 -->
            </div>
            <div class="navbar-header pull-right">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <i class="fa fa-2x fa-bars"></i>
              </button>
            </div>
          </div>
          <!-- <div class="col&#45;md&#45;9 col&#45;sm&#45;8 col&#45;xs&#45;12"> -->
          <!-- <div class="row"> -->
          <!--   <h2 class="blog&#45;title&#45;pro col&#45;md&#45;6 col&#45;sm&#45;12 col&#45;xs&#45;12 ">Writing my first Stata plugin: A real world use case</h2> -->
          <!--    -->
          <!--   <div class="col&#45;md&#45;6 col&#45;sm&#45;12 col&#45;xs&#45;12 searchcontrol" id="js&#45;search"> -->
          <!--     <input class="form&#45;control" type="text" id="js&#45;search__input" placeholder="Search"> -->
          <!--     <ul class="search__results" id="js&#45;search__results"></ul> -->
          <!--   </div> -->
          <!--    -->
          <!--   </div> -->
          <!--   <p class="info"> -->
          <!--      -->
          <!--       <span class="time">14 Feb 2017</span> -->
          <!--      -->
          <!--      -->
          <!--       <span class="categories"> -->
          <!--         &#38;raquo;  -->
          <!--          -->
          <!--           <a href="/category/stata">stata</a> -->
          <!--           ,  -->
          <!--          -->
          <!--           <a href="/category/plugins">plugins</a> -->
          <!--            -->
          <!--          -->
          <!--       </span> -->
          <!--      -->
          <!--   </p> -->
          <!-- </div> -->
        </div>
    </div>
</div>

    <div class="container main outer">
      <div class="row">
        <div class="col-md-3 col-xs-12">
              <nav class="menu">
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <!-- style="margin&#45;right:6px;padding&#45;right:6px" -->
<ul class="adj-ul-nav-width list-separator nav navbar-nav well well-primary post">

	
	
	
	
	
	
    
	
	<!-- <li class="col&#45;lg&#45;12 col&#45;md&#45;12 col&#45;sm&#45;4 col&#45;xs&#45;12 current-menu-item writing-stata-plugins-example.html"><a href="/" target="_self"><i class="fa fa-home"></i> Home</a></li> -->
     <!-- style="margin&#45;left:0px;padding&#45;left:0px;" -->
	<li class="adj-li-nav-width col-lg-12 col-md-12 col-sm-4 col-xs-12 current-menu-item writing-stata-plugins-example.html">
        <a href="/" target="_self">
            <i class="fa fa-home" style="width:42px;"></i>
            Home
        </a>
    </li>

	
	
	
	
	
	
    
	
	<!-- <li class="col&#45;lg&#45;12 col&#45;md&#45;12 col&#45;sm&#45;4 col&#45;xs&#45;12  writing-stata-plugins-example.html"><a href="/assets/CV_CaceresBravo.pdf" target="_blank"><i class="fa fa-graduation-cap"></i> CV</a></li> -->
     <!-- style="margin&#45;left:0px;padding&#45;left:0px;" -->
	<li class="adj-li-nav-width col-lg-12 col-md-12 col-sm-4 col-xs-12  writing-stata-plugins-example.html">
        <a href="/assets/CV_CaceresBravo.pdf" target="_blank">
            <i class="fa fa-graduation-cap" style="width:42px;"></i>
            CV
        </a>
    </li>

	
	
	
	
	
	
    
	
	<!-- <li class="col&#45;lg&#45;12 col&#45;md&#45;12 col&#45;sm&#45;4 col&#45;xs&#45;12  writing-stata-plugins-example.html"><a href="/research" target="_self"><i class="fa fa-book"></i> Research</a></li> -->
     <!-- style="margin&#45;left:0px;padding&#45;left:0px;" -->
	<li class="adj-li-nav-width col-lg-12 col-md-12 col-sm-4 col-xs-12  writing-stata-plugins-example.html">
        <a href="/research" target="_self">
            <i class="fa fa-book" style="width:42px;"></i>
            Research
        </a>
    </li>

	
	
	
	
	
	
    
	
	<!-- <li class="col&#45;lg&#45;12 col&#45;md&#45;12 col&#45;sm&#45;4 col&#45;xs&#45;12  writing-stata-plugins-example.html"><a href="/teaching" target="_self"><i class="fa fa-university"></i> Teaching</a></li> -->
     <!-- style="margin&#45;left:0px;padding&#45;left:0px;" -->
	<li class="adj-li-nav-width col-lg-12 col-md-12 col-sm-4 col-xs-12  writing-stata-plugins-example.html">
        <a href="/teaching" target="_self">
            <i class="fa fa-university" style="width:42px;"></i>
            Teaching
        </a>
    </li>

	
	
	
	
	
	
    
	
	<!-- <li class="col&#45;lg&#45;12 col&#45;md&#45;12 col&#45;sm&#45;4 col&#45;xs&#45;12  writing-stata-plugins-example.html"><a href="/coding" target="_self"><i class="fa fa-code"></i> Coding</a></li> -->
     <!-- style="margin&#45;left:0px;padding&#45;left:0px;" -->
	<li class="adj-li-nav-width col-lg-12 col-md-12 col-sm-4 col-xs-12  writing-stata-plugins-example.html">
        <a href="/coding" target="_self">
            <i class="fa fa-code" style="width:42px;"></i>
            Coding
        </a>
    </li>

</ul>

<!-- <ul  -->
<!--     class="adj-ul-nav-width list-separator nav navbar-nav well well-primary post" -->
<!--     style="list-style-type: none; margin-left:-15px; margin-rigt:12; padding: 0; display: flex; justify-content: space-around; width: 100%;"> -->
<!--  -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!--      -->
<!-- 	 -->
<!-- col-lg-12 col-md-12 col-sm-4 col-xs-12 -->
<!-- 	<li  -->
<!--         class="adj-li-nav-width col-lg-12 col-sm-4 col-xs-12 current-menu-item writing-stata-plugins-example.html"  -->
<!--         style=" flex-grow: 1;text-align: center;" > -->
<!--         <a href="/" target="_self" -->
<!--             style="display:block;"> -->
<!--             <i class="fa fa-home" style="width:24px;"></i> -->
<!--             Home -->
<!--         </a> -->
<!--     </li> -->
<!--  -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!--      -->
<!-- 	 -->
<!-- col-lg-12 col-md-12 col-sm-4 col-xs-12 -->
<!-- 	<li  -->
<!--         class="adj-li-nav-width col-lg-12 col-sm-4 col-xs-12  writing-stata-plugins-example.html"  -->
<!--         style=" flex-grow: 1;text-align: center;" > -->
<!--         <a href="/assets/CV_CaceresBravo.pdf" target="_blank" -->
<!--             style="display:block;"> -->
<!--             <i class="fa fa-graduation-cap" style="width:24px;"></i> -->
<!--             CV -->
<!--         </a> -->
<!--     </li> -->
<!--  -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!--      -->
<!-- 	 -->
<!-- col-lg-12 col-md-12 col-sm-4 col-xs-12 -->
<!-- 	<li  -->
<!--         class="adj-li-nav-width col-lg-12 col-sm-4 col-xs-12  writing-stata-plugins-example.html"  -->
<!--         style=" flex-grow: 1;text-align: center;" > -->
<!--         <a href="/research" target="_self" -->
<!--             style="display:block;"> -->
<!--             <i class="fa fa-book" style="width:24px;"></i> -->
<!--             Research -->
<!--         </a> -->
<!--     </li> -->
<!--  -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!--      -->
<!-- 	 -->
<!-- col-lg-12 col-md-12 col-sm-4 col-xs-12 -->
<!-- 	<li  -->
<!--         class="adj-li-nav-width col-lg-12 col-sm-4 col-xs-12  writing-stata-plugins-example.html"  -->
<!--         style=" flex-grow: 1;text-align: center;" > -->
<!--         <a href="/teaching" target="_self" -->
<!--             style="display:block;"> -->
<!--             <i class="fa fa-university" style="width:24px;"></i> -->
<!--             Teaching -->
<!--         </a> -->
<!--     </li> -->
<!--  -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!-- 	 -->
<!--      -->
<!-- 	 -->
<!-- col-lg-12 col-md-12 col-sm-4 col-xs-12 -->
<!-- 	<li  -->
<!--         class="adj-li-nav-width col-lg-12 col-sm-4 col-xs-12  writing-stata-plugins-example.html"  -->
<!--         style=" flex-grow: 1;text-align: center;" > -->
<!--         <a href="/coding" target="_self" -->
<!--             style="display:block;"> -->
<!--             <i class="fa fa-code" style="width:24px;"></i> -->
<!--             Coding -->
<!--         </a> -->
<!--     </li> -->
<!--  -->
<!-- </ul> -->

    </div>
    </nav>

        </div>
        <div class="col-md-9 col-xs-12 full">
          <div class="post-content well">
<div class="list-group">
    <h4 class="home-subtitle" style="font-size:39px">
      Writing my first Stata plugin: A real world use case
    </h4>
    <div class="fullw-list-group-separator"></div>
</div>

<!-- <div class="post&#45;content"> -->
<article class="content">
    <div class="post"><script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<p>I’m not the biggest fan of Stata. Though I use it every day for RA work,
and Stata does shine when all you want to do is explore one data set (or
a series of data sets that are easy to merge), it’s become increasingly
apparent over time that whenever I want to do something complex or
computationally intensive, it pales.</p>

<p><a href="www.stata.com/features/overview/introduction-to-mata/">Mata</a> makes many
of the rougher corners of Stata rather bearable. However, optimizing
Stata for a speedy run is really difficult. Enter <a href="www.stata.com/plugins/">Stata plugins</a>.</p>

<h2 id="what-are-stata-plugins">What are Stata plugins?</h2>

<p>A Stata plugin is pre-recompiled code, written in C or C++, that can
interact with Stata using the “Stata Plugin Interface (SPI).” Stata
provides a C source file and header that allows a C program to interact
with Stata’s data sets and matrices.</p>

<p>The implementation is relatively crude. Stata can write/read to/from
C one observation at a time from/to existing variables and matrices.
<a href="www.stata.com/plugins/">Stata has pretty good documentation</a> for the
functionality of their plugins, and I will not repeat all of it here.</p>

<p>A simple hello world program would be as follows:</p>
<ul>
  <li>Get a C compiler (<code>gcc</code>, the GNU Compiler Collection, is standard and should be included on Mac and Linux; look into <a href="http://www.mingw.org">MinGW</a> if you are on Windows to use <code>gcc</code>).</li>
  <li>Download the Stata Splugin Interface (SPI) version 2 (Stata &lt;= 13) or 3 (Stata &gt;= 14).
    <ul>
      <li>Version 2: <a href="http://www.stata.com/plugins/version2/stplugin.c">stplugin.c</a>, <a href="http://www.stata.com/plugins/version2/stplugin.h">stplugin.h</a></li>
      <li>Version 3: <a href="http://www.stata.com/plugins/stplugin.c">stplugin.c</a>, <a href="http://www.stata.com/plugins/stplugin.h">stplugin.h</a></li>
    </ul>
  </li>
  <li>Create hello.c (Note you should have stplugin.h and stplugin.c in the same directory).</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c">#include &quot;stplugin.h&quot;

STDLL stata_call(int argc, char *argv[])
{
    SF_display (&quot;Hello World\n&quot;);
    return (0);
}</code></pre></figure>

<ul>
  <li>Now from the command line, run</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcc -shared -fPIC -DSYSTEM=OPUNIX stplugin.c hello.c -o hello.plugin # Linux
gcc -bundle -DSYSTEM=APPLEMAC stplugin.c hello.c -o hello.plugin     # Mac</code></pre></figure>

<ul>
  <li>Last, from Stata navigate to your working directory and run</li>
</ul>

<figure class="highlight"><pre><code class="language-stata" data-lang="stata">program hello, plugin using(&quot;./hello.plugin&quot;)
plugin call hello</code></pre></figure>

<h2 id="is-it-worth-the-hassle">Is it worth the hassle?</h2>

<p>Stata says that it’s only worth it if you are replacing a lot of interpreted
ado-code and the task is not very complex. Though I agree on the latter
(complex tasks will likely take more time to code in C than the time they
will save) I <em>strongly</em> disagree on the former.</p>

<p>Perhaps most people realize this, but my understanding of for loops in
Stata is that they are run as if you printed each block within the for
loop however many times you tell it to execute. Thus</p>

<figure class="highlight"><pre><code class="language-stata" data-lang="stata">forvalues i = 1 / 1000 {
    // Stuff to do
}</code></pre></figure>

<p>may look like three lines of code, but it’s really equivalent to 1000.
The reason I started using Stata plugins was to speed up a simulation.
The C code is longer and the base case are only a handful of lines in
Stata, but it’s painfully slow because the bulk of the computation takes
place inside a loop that does a simulation.</p>

<p>Below I document a real-world use case where C was 50 times faster than
Stata, so for me the work was definitely worthwhile.</p>

<h2 id="a-real-world-use-case">A real world use case</h2>

<p>Several of the projects I work on are Randomized Control Trials. It is
standard to conduct a power analysis for such projects in order to put
together a proposal, etc. Having a well-powered trial is essential for
the success of an RCT.</p>

<p>Since RCTs can give you a truly independent treatment variable, we can
recover the treatment effect via simple OLS. Though parametric methods
are well known and widely used to estimate power under this setup,
they rely on strong assumptions. When clustering or stratification are
involved, specially when the number of clusters is not very large,
parametric calculations can be inaccurate.</p>

<p>One suggestion I got was to <em>simulate</em> power. I won’t outline the full
rationale (<a href="https://github.com/mcaceresb/stata-power/blob/master/notes/power-simulation-notes.pdf">read about it here</a>), but the crux of the idea is to simulate a large number of
coefficients $b$ for the equation:</p>

\[Y_{ij} = a + b T_{ij} + g X_{ij} + e_{ij}\]

<p>where at each step of the simulation, $T_{ij}$ is simulated so that
there are $NP$ individuals/clusters in treatment and $(1 - P)N$
in control. Since treatment is assigned randomly, the resulting
distribution is a sample of the true distribution of $b$ under the null
$H_0: b = 0$.</p>

<p>This does not tell us anything about power by itself, but the confidence
interval can be used as the basis of an iterative procedure to simulate
power. Hence coding the simulation efficiently is crucial.</p>

<h2 id="why-write-a-plugin">Why write a plugin?</h2>

<p>The problem above is actually very simple to implement. In pseudo-code:</p>

<figure class="highlight"><pre><code class="language-stata" data-lang="stata">function simci (X, y, P, reps)
{
    n = rows(X)
    b = zeros(reps)
    T = ones(ceil(n * P)) \ zeros(floor(n * (1 - P)))

    for (r = 1; r &lt;= reps; r++)
    {
        XT   = shuffle(T), X
        b[r] = (inv(XT&#39; * XT) * (XT&#39; * y))[1]
    }

    return (b)
}</code></pre></figure>

<p>Though simple, doing this <em><strong>efficiently</strong></em> is impossible in
Stata. There are three prominent issues:</p>
<ol>
  <li>
    <p>There is no way to shuffle a vector in Stata. That’s not a thing.
Variables all exist in relation to each other and sorting one
variable randomly will sort the entire data set. Shuffling an entire
data set is much slower than shuffling one vector.</p>
  </li>
  <li>
    <p>There is no way to compute just the regression coefficients in Stata.
Stata’s <code>regress</code> computes a host of things along with the least
squares solution This adds unnecessary overhead. (I have asked about
how to do this before; the suggestion I got was to run <code>quietly
regress, notable</code> which just controls what Stata outputs, not what it
computes).</p>
  </li>
  <li>
    <p>It’s not obvious how to store the results, specially with Stata/IC.
Though the buffer versions of Stata should be able to handle most
simulations after setting a larger <code>matsize</code>, the fact matrix sizes
are capped (and in Stata/IC capped at 800), makes the function
difficult to code.</p>
  </li>
</ol>

<p>The solution in Stata would look like this</p>

<figure class="highlight"><pre><code class="language-stata" data-lang="stata">program stataSimci, rclass sortpreserve
    syntax varlist [if] [in] , [ Ptreat(real 0.5) reps(int 100) ]

    gettoken depvar controls: varlist
    marksample touse
    _rmcoll `controls&#39; if `touse&#39;
    local controls `r(varlist)&#39;

    qui {
    preserve
        keep if `touse&#39;
        local NP = ceil(`=_N&#39; * `ptreat&#39;)

        tempname b
        tempvar treatment randsort
        gen byte   `treatment&#39; = .
        gen double `randsort&#39;  = .

        forvalues r = 1 / `reps&#39; {
            replace `randsort&#39;  = runiform()
            sort `randsort&#39;
            replace `treatment&#39; = (_n &lt;= `NP&#39;)
            regress `depvar&#39; `treatment&#39; `controls&#39; if `touse&#39;
            matrix `b&#39; = nullmat(`b&#39;) \ `:di _b[`treatment&#39;]&#39;
        }
    restore
    }

    return matrix b = `b&#39;
end

sysuse auto, clear
stataSimci price mpg foreign, p(0.5) reps(10)
matrix list r(b)</code></pre></figure>

<p>This is a hugely inefficient program!</p>

<h2 id="wait-cant-mata-handle-these-things">Wait, can’t Mata handle these things?</h2>

<p>Right, Mata is the elephant in the room. If you don’t know,
<a href="http://www.stata.com/features/overview/introduction-to-mata/">Mata</a> is
a programming language that is shipped with every version of Stata and
it can interact with Stata relatively easily. If you have ever used an
object-oriented programming language then you will recognize Mata as a
more standard programming language than Stata.</p>

<p>Mata does afford us <em>some</em> efficiency, but not a lot (yes, I know about
<code>.mlib</code> files and that technically Stata compiles mata into bytecode
when read into memory, but I have never found the speed improvement to
be significant).</p>

<p>In this case, Mata will run faster largely because it can</p>
<ol>
  <li>
    <p>Shuffle just a single vector.</p>
  </li>
  <li>
    <p>Get the OLS coefficients without any additional computations.</p>
  </li>
</ol>

<p>The implementation is very straightforward:</p>

<figure class="highlight"><pre><code class="language-stata" data-lang="stata">program mataSimci, rclass sortpreserve
    syntax varlist [if] [in] , [ Ptreat(real 0.5) reps(int 100) ]
    gettoken depvar controls: varlist
    marksample touse
    _rmcoll `controls&#39; if `touse&#39;
    local controls `r(varlist)&#39;
    mata: b = simci(&quot;`depvar&#39;&quot;, &quot;`controls&#39;&quot;, &quot;`touse&#39;&quot;, `ptreat&#39;, `reps&#39;)
    mata: st_matrix(&quot;b&quot;, b)
    return matrix b = b
end

mata:
real colvector function simci(string scalar depvar,
                              string scalar controls,
                              string scalar touse,
                              real scalar P,
                              real scalar reps)
{
    real scalar n
    real colvector b, T, y
    real matrix X

    y = X = .
    st_view(y, ., depvar,   touse)
    st_view(X, ., controls, touse)

    n = rows(X)
    b = J(reps, 1, missingof(X))
    T = J(ceil(n * P), 1, 1) \ J(floor(n * (1 - P)), 1, 0)

    for (r = 1; r &lt;= reps; r++)
    {
        XT   = (jumble(T), X)
        b[r] = (invsym(cross(XT, 1, XT, 1)) * cross(XT, 1, y, 0))[1]
    }

    return(b)
}
end

sysuse auto, clear
mataSimci price mpg foreign, p(0.5) reps(10)
matrix list r(b)</code></pre></figure>

<p>There are two problems:</p>
<ol>
  <li>
    <p>Matrix operations in Mata are not terribly fast (certainly not
compered to a compiled language like C or even a JIT-compiled
language like Julia). Yes, I know Mata uses LAPACK and BLAS
underneath, but it’s still largely an interpreted language.</p>
  </li>
  <li>
    <p>There is no reason to run the loop sequentially! It is conceptually
trivial to parallelize the loop. Granted, parallelism is not trivial
but the fact it cannot be done, even in Stata/MP, is frustrating.</p>
  </li>
</ol>

<h2 id="how-does-the-solution-in-c-look-like">How does the solution in C look like?</h2>

<p>C is certainly harder to write, and Stata’s primitive interaction with
C makes it so getting the results back from C is annoying. BUT there is
a MASSIVE speed improvement. For this particular use case it’s an order
of magnitude (around 10x) over Mata (and that implementation was already
faster than Stata).</p>

<p>Writing the wrapper for this is not too hard thanks to the GNU
Scientific Library. Noting the 0-based indexing:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">#include &lt;math.h&gt;
#include &lt;omp.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;time.h&gt;
#include &lt;gsl/gsl_blas.h&gt;
#include &lt;gsl/gsl_linalg.h&gt;
#include &lt;gsl/gsl_matrix_double.h&gt;
#include &lt;gsl/gsl_permutation.h&gt;
#include &lt;gsl/gsl_randist.h&gt;
#include &lt;gsl/gsl_rng.h&gt;
#include &quot;stplugin.h&quot;

// These functions are to be used after reading Stata data into X, y.
// Crucially, in this example the first column of X must be empty.

int simci (const gsl_matrix * X,
           const gsl_vector * y,
           const double P,
           const int reps,
           gsl_vector * b);
double sim_ols(const gsl_matrix * X, const gsl_vector * y);

// This function would read the data from stata
STDLL stata_call(int argc, char *argv[])
{

    // Initialize the variables to use
    ST_int      i, j ;
    ST_double   z ;
    ST_retcode  rc ;

    // Get P and number of reps. Note the 0-based indexing! So the
    // functiona ssumes P and reps were the 2nd and 3rd argument.
    double P    = strtod (argv[1], NULL);
    double reps = strtod (argv[2], NULL);

    const size_t n = SF_in2();
    const int    k = SF_nvars();
    gsl_matrix *X  = gsl_matrix_alloc (n, k + 1);
    gsl_vector *y  = gsl_vector_alloc (n);

    // Not sure if there is another way to read data vs the double loop.
    // Again, careful with the 0-based indexing!
    for (i = SF_in1(); i &lt;= SF_in2(); i++) {
        if (SF_ifobs(i)) {

            // Variables 2 through k are covariates
            for (j = 2; j &lt;= k; j++) {
                // Note we leave the first column empty
                if ( (rc = SF_vdata(j, i, &amp;z)) ) return(rc);
                gsl_matrix_set (X, i - 1, j - 1, z);
            }

            // Note we add the constant
            gsl_matrix_set (X,  i - 1, k, 1.0);

            // Variable 1 is the dependent variable
            if ( (rc = SF_vdata(1, i, &amp;z)) ) return(rc);
            gsl_vector_set (y,  i - 1, z);
        }
    }

    // Now we call the simulation function and output the results into b
    gsl_vector *b = gsl_vector_alloc (reps);
    simci (X, y, P, reps, b);

    gsl_matrix_free (X);
    gsl_vector_free (y);

    // Note the first argument passed to the plugin call must be the
    // name of a matrix that exists in Stata.
    for (i = 0; i &lt; b-&gt;size; i++) {
        SF_mat_store (argv[0], i + 1, 1, gsl_vector_get (b, i));
    }

    // The method above is a hassle because Stata limits matrix size and
    // the matrix has to exist. Some workarounds:
    // - Space-delimited local macro, then read using mata: tokens()
    // - Write to a temporary file then read using mata: cat()

    return (0);
}

// This will output the results into b
int simci (const gsl_matrix * X,
           const gsl_vector * y,
           const double P,
           const int reps,
           gsl_vector * b)
{

    const size_t n = X-&gt;size1;
    const int k    = X-&gt;size2;
    const int np   = ceil(n * P);

    // Set the random seed based on the time of day (seconds)
    srand (time(NULL));
    gsl_rng *rng = gsl_rng_alloc (gsl_rng_default);
    gsl_rng_set (rng, rand());

    // Get vector of 1s and 0s
    gsl_vector *T = gsl_vector_alloc (n);
    gsl_vector_set_zero (T);
    for (int i = 0; i &lt; np; i++) {
        gsl_vector_set (T, i, 1.0);
    }

    // Initialize elements for parallel loop
    gsl_vector *Tp ;
    gsl_matrix *Xp ;

    // Parallelize execution
    #pragma omp parallel private(Xp, Tp) shared(y, b)
    {
        // Allocate to each therad their own copy
        Tp = gsl_vector_alloc (n);
        Xp = gsl_matrix_alloc (n, k);

        gsl_vector_memcpy (Tp, T);
        gsl_matrix_memcpy (Xp, X);

        // Parallel for loop through simulation
        #pragma omp for
        for (int r = 0; r &lt; reps; r++) {
            gsl_ran_shuffle (rng, Tp-&gt;data, n, sizeof(size_t));
            gsl_matrix_set_col (Xp, 0, Tp);
            gsl_vector_set (b, r, sim_ols(Xp, y));
        }

        // Cleanup
        gsl_matrix_free (Xp);
        gsl_vector_free (Tp);
    }

    // Cleanup
    gsl_vector_free (T);
    gsl_rng_free (rng);

    return (0);
}

double sim_ols(const gsl_matrix * X, const gsl_vector * y)
{

    // Allocate memory to express the system as Ax = b
    gsl_matrix *A = gsl_matrix_alloc (X-&gt;size2, X-&gt;size2);
    gsl_vector *b = gsl_vector_alloc (X-&gt;size2);
    gsl_vector *x = gsl_vector_alloc (X-&gt;size2);

    // Set A = X&#39; X and b = X&#39; y
    gsl_blas_dgemm (CblasTrans, CblasNoTrans, 1.0, X, X, 0.0, A);
    gsl_blas_dgemv (CblasTrans, 1.0, X, y, 0.0, b);

    // Cholesky decomposition
    gsl_linalg_cholesky_decomp1 (A);
    gsl_linalg_cholesky_solve (A, b, x);

    // Cleanup
    gsl_matrix_free (A);
    gsl_vector_free (b);

    return (gsl_vector_get(x, 0));
}</code></pre></figure>

<p>Save the code to <code>pluginSimci.c</code>. To compile <code>pluginSimci.plgin</code>, on top
of <code>gcc</code> and the SPI, you will need</p>
<ul>
  <li>The <a href="https://www.gnu.org/software/gsl">GNU Scientific Library (GSL)</a></li>
  <li><a href="http://www.openmp.org">OpenMP</a></li>
</ul>

<p>Again, you should have <code>stplugin.c</code> and <code>stplugin.h</code> in the same directory. Now on Linux/Unix, run</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">CFLAGS=&quot;-Wall -fopenmp -shared -fPIC -DSYSTEM=OPUNIX&quot;
gcc $CFLAGS -c -o stplugin.o    stplugin.c
gcc $CFLAGS -c -o pluginSimci.o pluginSimci.c
gcc $CFLAGS stplugin.o pluginSimci.o \
    -lgsl -lgslcblas -lm -o pluginSimci.plugin</code></pre></figure>

<p>Depending on your system, you may also need to add <code>-std=c99</code> as a flag and point to the location of the <code>libgsl*so</code> files. For instance, I regularly SSH into a RedHat server, and to compile I ran</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">CFLAGS=&quot;-Wall -std=c99 -fopenmp -shared -fPIC -DSYSTEM=OPUNIX&quot;
gcc -I/usr/local/lib $CFLAGS -c -o stplugin.o    stplugin.c
gcc -I/usr/local/lib $CFLAGS -c -o pluginSimci.o pluginSimci.c
gcc -L/usr/local/lib $CFLAGS  stplugin.o pluginSimci.o \
    -lgsl -lgslcblas -lm -o pluginSimci.plugin</code></pre></figure>

<p>To compile in other system, you should consult <a href="http://www.stata.com/plugins">Stata’s documentation</a>. Once compiled, from Stata:</p>

<figure class="highlight"><pre><code class="language-stata" data-lang="stata">matrix b = J(10, 1, .)
sysuse auto
program pluginSimci, plugin using(./pluginSimci.plugin)
plugin call pluginSimci price mpg foreign, b 0.5 10
matrix list b</code></pre></figure>

<h2 id="timing-performance">Timing performance</h2>

<p>I don’t really know of good Stata tools to profile performance. However,
it’s not too hard to time how long a command takes to run. I wrote a
simple wrapper for it, which we use with the programs above:</p>

<figure class="highlight"><pre><code class="language-stata" data-lang="stata">. local github https://raw.githubusercontent.com
. net install benchmark, from(`github&#39;/mcaceresb/stata-benchmark/master/)
. local benchmark benchmark, disp reps(5): qui

. set seed 42
. set matsize 800
. sysuse auto, clear
. tempfile auto
. save `auto&#39;
. qui forvalues i = 1 / 100 {
.     append using `auto&#39;
. }

. `benchmark&#39; stataSimci  price mpg foreign, p(0.5) reps(800)
1: 10.52 seconds
2: 9.143 seconds
3: 12.13 seconds
4: 14.25 seconds
5: 12.54 seconds
Average over 5 runs: 11.7166 seconds

. `benchmark&#39; mataSimci  price mpg foreign, p(0.5) reps(800)
 2.546 seconds
 2.692 seconds
 2.68 seconds
 2.368 seconds
 2.426 seconds
Average over 5 runs: 2.5424 seconds

. matrix b = J(800, 1, .)
. `benchmark&#39; plugin call pluginSimci price mpg foreign, b 0.5 800
1: .283 seconds
2: .273 seconds
3: .262 seconds
4: .238 seconds
5: .288 seconds
Average over 5 runs: 0.2688 seconds</code></pre></figure>

<p>In the example Mata ran 5x vs Stata and the plugin ran 10x vs Mata. For
a 50x speed improvement, I’d say the hassle was worth it! My real-world
use-case for this was power simulations for a cluster-randomized trial
where the underlying clusters were comprised of 200k observations
overall. Running this in Mata took on the order of days. To have it run
in hours was a massive boon.</p>
</div>
    <!-- <hr /> -->
    <!-- <div class="share&#45;page"> -->
<!--     Share this on &#38;rarr; -->
<!--  <a href="https://twitter.com/share" class="twitter&#45;share&#45;button" data&#45;via="\#">Tweet</a> -->
<!-- <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter&#45;wjs');</script> -->
<!--  -->
<!-- <!&#45;&#45; Google + &#45;&#45;> -->
<!-- <div class="g&#45;plus" data&#45;action="share" data&#45;annotation="bubble"></div> -->
<!-- <script src="https://apis.google.com/js/platform.js" async defer></script> -->
<!--  -->
<!-- <!&#45;&#45; Facebook &#45;&#45;> -->
<!-- <div class="fb&#45;share&#45;button" data&#45;href="http://localhost:4000/stata/plugins/2017/02/14/writing-stata-plugins-example.html" data&#45;layout="button_count" style="position: relative; top: &#45;8px; left: 3px;"></div> -->
<!-- </div> -->
<!-- <div id="fb&#45;root"></div> -->
<!-- <script>(function(d, s, id) { -->
<!--   var js, fjs = d.getElementsByTagName(s)[0]; -->
<!--   if (d.getElementById(id)) return; -->
<!--   js = d.createElement(s); js.id = id; -->
<!--   js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&#38;version=v2.6&#38;appId=0"; -->
<!--   fjs.parentNode.insertBefore(js, fjs); -->
<!-- }(document, 'script', 'facebook&#45;jssdk'));</script> -->

</article>

<hr />


    
    
        
            
        
            
        
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    
        
            
        
            
        
    
        
            
        
            
        
    



<div class="PageNavigation">
  
    <a class="prev pull-left" href="http://localhost:4000/linux/arch/install/2017/02/10/install-arch-partI.html">&laquo; Installing Arch: Setting up the system</a>
  
  
  <br/>
</div>

<!-- <div class="disqus&#45;comments"> -->
<!--     <div id="disqus_thread"></div> -->
<!--     <script type="text/javascript"> -->
<!--         /* <![CDATA[ */ -->
<!--  -->
<!--         var disqus_shortname = ""; -->
<!--         var disqus_identifier = "http://localhost:4000_Writing my first Stata plugin: A real world use case"; -->
<!--         var disqus_title = "Writing my first Stata plugin: A real world use case"; -->
<!--  -->
<!--         /* * * DON'T EDIT BELOW THIS LINE * * */ -->
<!--         (function() { -->
<!--             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; -->
<!--             dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; -->
<!--             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); -->
<!--         })(); -->
<!--     /* ]]> */ -->
<!--     </script> -->
<!-- </div> -->
</div>

          <div class="row">
            <div class="col-md-12 col-xs-12 footer">
              <footer>
  © 2024 Mauricio M. Caceres Bravo - Powered by Jekyll.
</footer>

<div align="center">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-0000000000000000"
    data-ad-slot="0000000000"
    data-ad-format="auto"></ins>
  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

            </div>
          </div>
        </div> <!-- end /.col-md-9 -->
      </div> <!-- end /.row -->
    </div>

    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script src="/static/js/super-search.js"></script>

<script src="/static/js/thickbox-compressed.js"></script>
<script src="/static/js/material.min.js"></script>
<script src="/static/js/main.js"></script>
<script src="/static/js/projects.js"></script>
<script async defer src="/static/js/github_api.min.js"></script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-91854317-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
